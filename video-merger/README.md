# 動画結合ツール

複数の動画ファイルを順番に結合するWebアプリです。動画間に黒背景・白字のテロップカードを挿入することもできます。

## 機能

- 複数の動画ファイルをドラッグ&ドロップまたはファイル選択でアップロード
- 動画の並び順をドラッグで変更
- 動画と動画の間に任意のテキスト（テロップカード）を挿入
- テロップカードの表示時間を秒単位で指定
- 解像度の異なる動画を自動的に最大解像度に合わせてパディング（黒帯）
- スマートフォン撮影の縦動画（回転メタデータ付き）に対応
- 日本語テキスト対応（NotoSansCJKフォント使用）

## 対応フォーマット

MP4, MOV, AVI, MKV, WebM, FLV, M4V

## 使い方

### 起動

```bash
docker compose up --build
```

ブラウザで http://localhost:5000 にアクセス。

### 操作手順

1. 動画ファイルをドラッグ&ドロップ、またはファイルを選択してアップロード
2. アイテム間に表示される「+ テロップを挿入」ボタンでテロップカードを追加
3. テロップカードのテキストと表示時間を入力
4. ドラッグハンドル（⠿）でアイテムの順序を変更
5. 「結合する」ボタンをクリック
6. 処理完了後、`merged.mp4` が自動ダウンロードされる

## 技術スタック

| 項目 | 内容 |
|------|------|
| バックエンド | Python 3.12 / Flask |
| 動画処理 | FFmpeg / ffprobe |
| 画像生成 | Pillow (PIL) |
| フォント | NotoSansCJK |
| コンテナ | Docker / Docker Compose |

## アーキテクチャ

```
ブラウザ
  │  multipart/form-data (videos[] + items JSON)
  ▼
Flask (/merge)
  ├─ ffprobe で各動画の解像度・音声・回転情報を取得
  ├─ テロップカード: Pillow で PNG 生成 → FFmpeg で MP4 変換
  └─ FFmpeg filter_complex でスケール・パディング・concat
       └─ libx264 + aac で出力
```

### 解像度の正規化

すべての動画の最大幅・最大高さを基準サイズとし、サイズが小さい動画は `force_original_aspect_ratio=decrease` でアスペクト比を保ってスケールし、残りを黒帯でパディングします。

### 縦動画への対応

スマートフォンで撮影した縦動画は、映像データは横向きで保存されつつ、メタデータに回転情報（displaymatrix）が付与されています。ffprobe で回転角を検出し、90°/270° の場合は幅と高さを入れ替えて「表示後の寸法」を使用することで、FFmpeg のデコード後の出力と一致させています。

### 音声のない動画への対応

音声ストリームがない動画（テロップカードを含む）には `aevalsrc=0:c=stereo:s=44100:d={duration}` フィルタで無音を生成し、全アイテムを同じ形式で concat します。
