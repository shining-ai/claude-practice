<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‹•ç”»çµåˆãƒ„ãƒ¼ãƒ«</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>å‹•ç”»çµåˆãƒ„ãƒ¼ãƒ«</h1>
    <p class="subtitle">è¤‡æ•°ã®å‹•ç”»ã‚’1ã¤ã«çµåˆã—ã¾ã™ã€‚è§£åƒåº¦ãŒç•°ãªã‚‹å ´åˆã¯æœ€å¤§ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦é»’å¸¯ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>

    <div class="drop-zone" id="dropZone">
      <div class="drop-icon">ğŸ¬</div>
      <p class="drop-text">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
      <p class="drop-sub">ã¾ãŸã¯</p>
      <label class="btn-select" for="fileInput">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
      <input type="file" id="fileInput" accept="video/*" multiple hidden />
      <p class="supported">å¯¾å¿œå½¢å¼: MP4, MOV, AVI, MKV, WebM, FLV, M4V</p>
    </div>

    <ul class="file-list" id="fileList"></ul>

    <div class="actions">
      <button class="btn-merge" id="mergeBtn" disabled>çµåˆã™ã‚‹</button>
      <button class="btn-clear" id="clearBtn" hidden>ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="progress-area" id="progressArea" hidden>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p class="progress-text" id="progressText">å‡¦ç†ä¸­...</p>
    </div>

    <div class="error-area" id="errorArea" hidden>
      <p class="error-msg" id="errorMsg"></p>
    </div>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const mergeBtn = document.getElementById('mergeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const progressArea = document.getElementById('progressArea');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const errorArea = document.getElementById('errorArea');
    const errorMsg = document.getElementById('errorMsg');

    let selectedFiles = [];

    // Drag & drop events
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      addFiles([...e.dataTransfer.files]);
    });

    fileInput.addEventListener('change', () => {
      addFiles([...fileInput.files]);
      fileInput.value = '';
    });

    function addFiles(newFiles) {
      const videoFiles = newFiles.filter(f => f.type.startsWith('video/') || /\.(mp4|mov|avi|mkv|webm|flv|m4v)$/i.test(f.name));
      videoFiles.forEach(f => selectedFiles.push(f));
      renderFileList();
    }

    function renderFileList() {
      fileList.innerHTML = '';
      selectedFiles.forEach((file, i) => {
        const li = document.createElement('li');
        li.className = 'file-item';
        li.draggable = true;
        li.dataset.index = i;

        const handle = document.createElement('span');
        handle.className = 'drag-handle';
        handle.textContent = 'â ¿';

        const info = document.createElement('span');
        info.className = 'file-info';
        info.textContent = `${i + 1}. ${file.name} (${formatSize(file.size)})`;

        const del = document.createElement('button');
        del.className = 'btn-delete';
        del.textContent = 'âœ•';
        del.addEventListener('click', () => {
          selectedFiles.splice(i, 1);
          renderFileList();
        });

        li.appendChild(handle);
        li.appendChild(info);
        li.appendChild(del);
        fileList.appendChild(li);

        // Drag to reorder
        li.addEventListener('dragstart', onDragStart);
        li.addEventListener('dragover', onDragOver);
        li.addEventListener('drop', onDrop);
        li.addEventListener('dragend', onDragEnd);
      });

      mergeBtn.disabled = selectedFiles.length < 2;
      clearBtn.hidden = selectedFiles.length === 0;
      hideError();
    }

    function formatSize(bytes) {
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      if (bytes < 1024 * 1024 * 1024) return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
      return `${(bytes / 1024 / 1024 / 1024).toFixed(2)} GB`;
    }

    // Drag to reorder
    let dragSrcIndex = null;

    function onDragStart(e) {
      dragSrcIndex = parseInt(this.dataset.index);
      this.classList.add('dragging');
    }

    function onDragOver(e) {
      e.preventDefault();
      this.classList.add('drag-over');
    }

    function onDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      const targetIndex = parseInt(this.dataset.index);
      if (dragSrcIndex !== null && dragSrcIndex !== targetIndex) {
        const moved = selectedFiles.splice(dragSrcIndex, 1)[0];
        selectedFiles.splice(targetIndex, 0, moved);
        renderFileList();
      }
    }

    function onDragEnd() {
      document.querySelectorAll('.file-item').forEach(el => {
        el.classList.remove('dragging', 'drag-over');
      });
      dragSrcIndex = null;
    }

    clearBtn.addEventListener('click', () => {
      selectedFiles = [];
      renderFileList();
    });

    mergeBtn.addEventListener('click', async () => {
      hideError();
      progressArea.hidden = false;
      mergeBtn.disabled = true;
      clearBtn.hidden = true;
      animateProgress();

      const formData = new FormData();
      selectedFiles.forEach(f => formData.append('videos', f));

      try {
        const res = await fetch('/merge', { method: 'POST', body: formData });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${res.status})`);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'merged.mp4';
        a.click();
        URL.revokeObjectURL(url);

        progressFill.style.width = '100%';
        progressText.textContent = 'å®Œäº†ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå§‹ã¾ã‚Šã¾ã™ã€‚';
      } catch (err) {
        showError(err.message);
      } finally {
        setTimeout(() => {
          progressArea.hidden = true;
          progressFill.style.width = '0%';
          mergeBtn.disabled = selectedFiles.length < 2;
          clearBtn.hidden = selectedFiles.length === 0;
        }, 2000);
      }
    });

    function animateProgress() {
      progressFill.style.width = '0%';
      progressText.textContent = 'å‡¦ç†ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
      let pct = 0;
      const interval = setInterval(() => {
        if (pct < 90) {
          pct += Math.random() * 3;
          progressFill.style.width = `${Math.min(pct, 90)}%`;
        } else {
          clearInterval(interval);
        }
      }, 400);
    }

    function showError(msg) {
      errorMsg.textContent = msg;
      errorArea.hidden = false;
      progressArea.hidden = true;
    }

    function hideError() {
      errorArea.hidden = true;
    }
  </script>
</body>
</html>
